name: Fetch FEXCore Nightly (From Upstream)

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  fetch-and-package:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Find and Download Latest Artifact
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 1. Find the latest successful run ID for 'wine_dll_artifacts.yml' on 'main'
        RUN_ID=$(gh run list --repo FEX-Emu/FEX --workflow wine_dll_artifacts.yml --branch main --status success --limit 1 --json databaseId --jq '.[0].databaseId')
        echo "Found Run ID: $RUN_ID"

        # 2. List artifacts in this run to find the correct name
        # We grab the first artifact name found in this run
        ARTIFACT_NAME=$(gh run view $RUN_ID --repo FEX-Emu/FEX --json artifacts --jq '.artifacts[0].name')
        
        if [ -z "$ARTIFACT_NAME" ] || [ "$ARTIFACT_NAME" = "null" ]; then
          echo "::error::No artifacts found in run $RUN_ID"
          exit 1
        fi
        
        echo "Found Artifact Name: $ARTIFACT_NAME"

        # 3. Download the artifact using the discovered name
        gh run download $RUN_ID --repo FEX-Emu/FEX --name "$ARTIFACT_NAME" --dir downloaded_artifacts

    - name: Repackage DLLs
      run: |
        mkdir -p packaging/system32
        
        # Check what we actually downloaded
        ls -R downloaded_artifacts/
        
        # Copy and RENAME the files (upstream names -> your names)
        # Note: We use 'find' to be safer in case the folder structure varies inside the zip
        find downloaded_artifacts -name "libarm64ecfex.dll" -exec cp {} packaging/system32/libarm64ec.dll \;
        find downloaded_artifacts -name "libwow64fex.dll" -exec cp {} packaging/system32/libwow64fex.dll \;

    - name: Create profile.json
      run: |
        BUILD_DATE=$(date +'%Y-%m-%d')
        VERSION_CODE=${{ github.run_number }}
        
        cat <<EOF > packaging/profile.json
        {
          "type": "FEXCore",
          "versionName": "Nightly-${BUILD_DATE}",
          "versionCode": ${VERSION_CODE},
          "description": "FEXCore Nightly (Upstream Artifacts)\nDate: ${BUILD_DATE}",
          "author": "The412Banner",
          "files": [
            { "source": "system32/libarm64ec.dll", "target": "\${system32}/libarm64ec.dll" },
            { "source": "system32/libwow64fex.dll", "target": "\${system32}/libwow64fex.dll" }
          ]
        }
        EOF

    - name: Upload Repackaged Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fex-nightly-package
        path: packaging/
