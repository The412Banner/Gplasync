  build-fexcore-native:
    name: Build FEXCore (Android Native)
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake ninja-build python3 wget tar clang-15 llvm-15

      - name: Setup Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV

      - name: Clone FEX
        run: git clone --recursive https://github.com/FEX-Emu/FEX source

      - name: Configure and Build
        run: |
          mkdir build && cd build
          # Using the NDK Toolchain file is the key "perk" for Android builds
          cmake ../source \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.ANDROID_NDK_HOME }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-28 \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_LTO=True \
            -G Ninja
          ninja FEXInterpreter FEXLoader FEXServer

      - name: Package
        run: |
          COMMIT=$(git -C source rev-parse --short HEAD)
          mkdir -p pkg/usr/local/bin
          cp build/Source/Tools/FEXInterpreter/FEXInterpreter pkg/usr/local/bin/
          cp build/Source/Tools/FEXLoader/FEXLoader pkg/usr/local/bin/
          
          echo '{"type": "FEXCore", "versionName": "fex-nightly-'${COMMIT}'", "versionCode": 0, "description": "FEXCore Nightly. Author: MaxsTechReview", "files": [{"source": "usr/local/bin/FEXInterpreter", "target": "${bindir}/FEXInterpreter"}]}' > pkg/profile.json
          tar -cJf "FEXCore-nightly-${COMMIT}.wcp" -C pkg .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fex-android-native
          path: "*.wcp"
