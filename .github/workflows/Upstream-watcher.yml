name: Upstream Commit Watcher

on:
  schedule:
    - cron: '0 * * * *' # Runs at minute 0 past every hour
  workflow_dispatch: # Allows you to run it manually

permissions:
  contents: write # Needed to commit the updated hashes file back to the repo
  actions: write  # Needed to trigger the main workflow

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Upstream Repositories
        id: check
        run: |
          # The list of upstream repositories your main workflow relies on
          REPOS=(
            "https://github.com/ptitSeb/box64"
            "https://github.com/Pipetto-crypto/box64"
            "https://github.com/FEX-Emu/FEX"
            "https://github.com/HansKristian-Work/vkd3d-proton"
            "https://github.com/doitsujin/dxvk"
            "https://github.com/jp7677/dxvk-nvapi"
          )
          
          # The tracking file that will be saved to your repo
          HASH_FILE="upstream_hashes.txt"
          touch $HASH_FILE # Creates the file if it doesn't exist yet
          
          NEW_HASHES=""
          
          echo "Checking latest commits..."
          for repo in "${REPOS[@]}"; do
            # Gets the latest commit hash for the default branch without cloning
            HASH=$(git ls-remote "$repo" HEAD | awk '{print $1}')
            NEW_HASHES="${NEW_HASHES}${repo}: ${HASH}\n"
          done
          
          # Save new hashes to a temporary file
          echo -e "$NEW_HASHES" > new_hashes.txt
          
          # Compare the temporary file with the existing tracking file
          if cmp -s "$HASH_FILE" new_hashes.txt; then
            echo "No new commits detected in upstream repositories."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "New commits detected!"
            mv new_hashes.txt "$HASH_FILE"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit Updated Hashes
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add upstream_hashes.txt
          git commit -m "chore: auto-update upstream commit hashes"
          git push

      - name: Trigger Main Build Workflow
        if: steps.check.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Triggers your main workflow via the GitHub CLI
          # Note: The filename must perfectly match the yaml file name of your main workflow
          gh workflow run "new-All-in-one-nightly+zips-latest-stable.yml"
          
