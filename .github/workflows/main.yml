name: Build FEXCore Nightly (Winlator)

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  # JOB 1: Build the ARM64 Host DLL (Isolated)
  build-arm64:
    runs-on: ubuntu-latest
    container: mstorsjo/llvm-mingw:latest
    steps:
    - name: Install Dependencies
      run: |
        apt-get update -y
        apt-get install -y git python3 python3-packaging python3-setuptools

    - name: Checkout FEX
      uses: actions/checkout@v4
      with:
        repository: FEX-Emu/FEX
        submodules: recursive
        fetch-depth: 0

    - name: Build libarm64ec.dll
      run: |
        mkdir build-arm64
        cd build-arm64
        
        # FIX: We explicitly set DLLTOOL to aarch64 to prevent x64 import libs from being created
        cmake .. -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
          -DCMAKE_SIZEOF_VOID_P=8 \
          -DCMAKE_C_COMPILER=aarch64-w64-mingw32-clang \
          -DCMAKE_CXX_COMPILER=aarch64-w64-mingw32-clang++ \
          -DCMAKE_RC_COMPILER=aarch64-w64-mingw32-windres \
          -DCMAKE_DLLTOOL=aarch64-w64-mingw32-dlltool \
          -DCMAKE_INSTALL_PREFIX=./install \
          -DENABLE_LTO=False \
          -DBUILD_TESTING=False
          
        ninja

    - name: Upload ARM64 Artifact
      uses: actions/upload-artifact@v4
      with:
        name: libarm64ec
        # Find the DLL regardless of output name and upload it
        path: build-arm64/**/*.dll

  # JOB 2: Build the WOW64 Guest DLL (Isolated)
  build-wow64:
    runs-on: ubuntu-latest
    container: mstorsjo/llvm-mingw:latest
    steps:
    - name: Install Dependencies
      run: |
        apt-get update -y
        apt-get install -y git python3 python3-packaging python3-setuptools

    - name: Checkout FEX
      uses: actions/checkout@v4
      with:
        repository: FEX-Emu/FEX
        submodules: recursive
        fetch-depth: 0

    - name: Build libwow64fex.dll
      run: |
        mkdir build-wow64
        cd build-wow64
        
        cmake .. -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_SYSTEM_PROCESSOR=x86_64 \
          -DCMAKE_SIZEOF_VOID_P=8 \
          -DCMAKE_C_COMPILER=x86_64-w64-mingw32-clang \
          -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-clang++ \
          -DCMAKE_RC_COMPILER=x86_64-w64-mingw32-windres \
          -DCMAKE_DLLTOOL=x86_64-w64-mingw32-dlltool \
          -DCMAKE_INSTALL_PREFIX=./install \
          -DENABLE_LTO=False \
          -DBUILD_TESTING=False
          
        ninja

    - name: Upload WOW64 Artifact
      uses: actions/upload-artifact@v4
      with:
        name: libwow64
        path: build-wow64/**/*.dll

  # JOB 3: Package them together
  package:
    runs-on: ubuntu-latest
    needs: [build-arm64, build-wow64]
    steps:
    - name: Download ARM64 Artifact
      uses: actions/download-artifact@v4
      with:
        name: libarm64ec
        path: packaging/system32

    - name: Download WOW64 Artifact
      uses: actions/download-artifact@v4
      with:
        name: libwow64
        path: packaging/system32

    - name: Rename and Bundle
      run: |
        cd packaging/system32
        
        # Rename the ARM64 file to what Winlator expects (libarm64ec.dll)
        # We find whatever file is there (likely libFEXCore.dll or libarm64ecfex.dll) and rename it
        find . -name "*.dll" -not -name "libwow64fex.dll" -exec mv {} libarm64ec.dll \;
        
        # Ensure WOW64 is named correctly
        find . -name "*wow64*.dll" -exec mv {} libwow64fex.dll \;
        
        ls -R
        
        cd ..
        
        # Create profile.json
        BUILD_DATE=$(date +'%Y-%m-%d')
        cat <<EOF > profile.json
        {
          "type": "FEXCore",
          "versionName": "Nightly-${BUILD_DATE}",
          "versionCode": 1,
          "description": "FEXCore Nightly (Split Build)\nDate: ${BUILD_DATE}",
          "author": "Blank",
          "files": [
            { "source": "system32/libarm64ec.dll", "target": "\${system32}/libarm64ec.dll" },
            { "source": "system32/libwow64fex.dll", "target": "\${system32}/libwow64fex.dll" }
          ]
        }
        EOF

    - name: Create WCP
      run: |
        tar -cJf FEXCore-Nightly.wcp -C packaging .

    - name: Upload Final Package
      uses: actions/upload-artifact@v4
      with:
        name: fexcore-nightly-package
        path: FEXCore-Nightly.wcp
