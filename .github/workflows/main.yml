name: Build DXVK 1.9.4 Async WCP (Local Patch)

on:
  workflow_dispatch:

jobs:
  build:
    # DOWNGRADE TO 22.04: This is required to compile older DXVK versions
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build gcc-mingw-w64 g++-mingw-w64 glslang-tools

      - name: Clone Official DXVK
        run: |
          git clone https://github.com/doitsujin/dxvk.git source
          cd source
          git checkout v1.9.4

      - name: Apply Local Async Patch
        run: |
          cd source
          patch -p1 < ../patches/dxvk-async-67e2ee1.patch

      - name: Build DXVK via Official Script
        run: |
          cd source
          # Using the older runner allows this native script to work flawlessly
          ./package-release.sh 1.9.4 "$GITHUB_WORKSPACE/package_output" --no-package

      - name: Structure WCP Package
        run: |
          mkdir -p package/x64 package/x86
          
          # The official script outputs exactly to these directories
          mv package_output/dxvk-1.9.4/x64/*.dll package/x64/
          mv package_output/dxvk-1.9.4/x32/*.dll package/x86/

      - name: Generate WCP Metadata
        run: |
          cat <<EOF > package/index.json
          {
            "name": "DXVK 1.9.4 Async",
            "version": "1.9.4",
            "author": "The412Banner",
            "description": "DXVK 1.9.4 patched with local dxvk-async-67e2ee1.patch.",
            "type": "dxvk",
            "files": {
              "x64": ["d3d9.dll", "d3d10core.dll", "d3d11.dll", "dxgi.dll"],
              "x86": ["d3d9.dll", "d3d10core.dll", "d3d11.dll", "dxgi.dll"]
            }
          }
          EOF

      - name: Package Artifact
        run: |
          cd package
          zip -9 -r ../dxvk-1.9.4-async.wcp ./*

      - name: Upload WCP
        uses: actions/upload-artifact@v4
        with:
          name: dxvk-1.9.4-async-wcp
          path: dxvk-1.9.4-async.wcp
