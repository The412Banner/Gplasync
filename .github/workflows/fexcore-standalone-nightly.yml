name: FEXCore Standalone Nightlies

on:
  workflow_dispatch:

jobs:
  # ==================================================================
  # JOB 1: FEXCore Nightly
  # ==================================================================
  build-fex:
    name: Build FEXCore
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils jq git zip \
            build-essential python3 pkg-config cmake zstd \
            dos2unix perl tar unzip meson ninja-build wget

      - name: Setup GLSLANG
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang
          echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Setup Toolchain
        run: |
          LLVM_MINGW_TAG="20251104"
          TOOLCHAIN_DIR="/opt/llvm-mingw"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo rm -rf "$TOOLCHAIN_DIR" && sudo mkdir -p "$TOOLCHAIN_DIR"
          sudo tar -C "$TOOLCHAIN_DIR" --strip-components=1 -xJf llvm.tar.xz
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

      - name: Build FEX
        id: version
        run: |
          git clone --recursive https://github.com/FEX-Emu/FEX.git source
          cd source
          
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "FEX-Unknown")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION_NAME="${LATEST_TAG}-Nightly-${COMMIT_HASH}"
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "version=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT_HASH}" >> $GITHUB_OUTPUT

          build_arch() {
            local triple="$1"
            local dest="$2"
            local build_dir="build-${triple}"
            
            rm -rf "$build_dir" && mkdir "$build_dir" && cd "$build_dir"
            cmake -G Ninja -Wno-dev \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
              -DMINGW_TRIPLE="${triple}-w64-mingw32" \
              -DCMAKE_INSTALL_PREFIX=/usr \
              -DCMAKE_INSTALL_LIBDIR=/usr/lib/wine/aarch64-windows \
              -DENABLE_JEMALLOC_GLIBC_ALLOC=False \
              -DENABLE_LTO=False -DENABLE_ASSERTIONS=False -DBUILD_TESTING=False \
              ..
            ninja -j 2
            DESTDIR="$dest" ninja install
            cd ..
          }

          build_arch "arm64ec" "../../stage-ec"
          build_arch "aarch64" "../../stage-wo"

      - name: Package
        run: |
          rm -rf final_package && mkdir -p final_package/system32
          DLL_EC=$(find stage-ec -type f -name '*.dll' | head -n 1)
          DLL_WOW=$(find stage-wo -type f -name '*.dll' | head -n 1)
          
          cp "$DLL_EC" final_package/system32/libarm64ecfex.dll
          cp "$DLL_WOW" final_package/system32/libwow64fex.dll
          /opt/llvm-mingw/bin/llvm-strip --strip-all final_package/system32/*.dll
          
          cat <<EOF > final_package/profile.json
          {
            "type": "FEXCore",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": ${{ github.run_number }},
            "description": "FEXCore Nightly\n${{ env.VERSION_NAME }}",
            "author": "FEX-Emu",
            "files": [
              { "source": "system32/libarm64ecfex.dll", "target": "\${system32}/libarm64ecfex.dll" },
              { "source": "system32/libwow64fex.dll", "target": "\${system32}/libwow64fex.dll" }
            ]
          }
          EOF
          
          cd final_package
          
          # Create WCP
          tar -cJf ../${{ env.VERSION_NAME }}.wcp .
          
          # Create ZIP
          zip -r ../${{ env.VERSION_NAME }}.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: fex-nightly
          path: |
            *.wcp
            *.zip

  # ==================================================================
  # JOB 2: Release
  # ==================================================================
  create-release:
    name: Create Nightly Release
    runs-on: ubuntu-latest
    needs: [build-fex]
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Set Release Variables
        run: |
          # Create a tag-safe timestamp (e.g., 20231025-090000)
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          # Create a human-readable date for the title (e.g., 2023-10-25 09:00:00 UTC)
          READABLE_DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')
          
          echo "TAG_NAME=fexcore-nightly-$TIMESTAMP" >> $GITHUB_ENV
          echo "RELEASE_NAME=FEXCore Nightly Build - $READABLE_DATE" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.RELEASE_NAME }}
          prerelease: false
          make_latest: true
          body: |
            ### ðŸš€ FEXCore Nightly Build: ${{ env.TAG_NAME }}
            
            | Component | Source / Commit |
            | :--- | :--- |
            | **FEXCore** | [${{ needs.build-fex.outputs.version }}](https://github.com/FEX-Emu/FEX/commit/${{ needs.build-fex.outputs.commit }}) |
            
            ### ðŸ“¦ Files Included
            1. **FEXCore**: `*-Nightly-*.wcp` (and `.zip`)
            
            **The .wcp files are packaged for use with Winlator**
            **The .zip files are packaged for manual injection with Gamehub**
          files: |
            ./artifacts/*.wcp
            ./artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
