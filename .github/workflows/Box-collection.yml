name: Build Box64 & WOWBox64 Collection

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-box-collection:
    name: Build All Box64 Variants
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Define the two repositories and three build types
        repo: [ptitSeb, Pipetto]
        type: [native, bionic, wow64]
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make python3 p7zip-full wget tar file unzip xz-utils zstd zip

      - name: Setup Android NDK (r26b)
        if: matrix.type != 'wow64'
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV

      - name: Setup Toolchain (LLVM-MinGW)
        if: matrix.type == 'wow64'
        run: |
          LLVM_MINGW_VERSION=20240619
          wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64.tar.xz
          tar -xf llvm-mingw-*.tar.xz
          echo "MINGW_PATH=$PWD/$(ls -d llvm-mingw-* | head -n 1)/bin" >> $GITHUB_ENV

      - name: Clone Source
        run: |
          REPO_URL="https://github.com/${{ matrix.repo }}/box64"
          git clone --depth 1 $REPO_URL source
          cd source
          echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Build Native/Bionic
        if: matrix.type != 'wow64'
        run: |
          # Choose compiler based on type (API 28 for Native, API 31 for Bionic)
          if [[ "${{ matrix.type }}" == "bionic" ]]; then
            COMPILER="${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android31-clang"
            EXTRA_OPTS="-DBIONIC=1 -DTERMUX=0 -DHAVE_TRACE=0"
          else
            COMPILER="${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android28-clang"
            EXTRA_OPTS=""
          fi
          
          mkdir build && cd build
          cmake ../source -DCMAKE_C_COMPILER=$COMPILER -DANDROID=1 -DARM_DYNAREC=1 -DBAD_SIGNAL=1 -DCMAKE_BUILD_TYPE=Release $EXTRA_OPTS
          make -j$(nproc)
          ${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip box64
          cp box64 ../

      - name: Build WOW64
        if: matrix.type == 'wow64'
        run: |
          export PATH=$PATH:${{ env.MINGW_PATH }}
          cd source
          mkdir -p wine/common
          echo -e '\nint __mingw_vsprintf(char* buffer, const char* format, va_list args) { return vsprintf(buffer, format, args); }' >> wine/common/crt.c
          cd ..
          mkdir build && cd build
          cmake ../source -DCMAKE_C_COMPILER=aarch64-w64-mingw32-gcc -DWOW64=1 -DARM_DYNAREC=1 -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc) wowbox64
          mkdir -p ../system32
          cp wowbox64-prefix/src/wowbox64-build/wowbox64.dll ../system32/

      - name: Package
        run: |
          # Generate variables
          LABEL="${{ matrix.repo }}-${{ matrix.type }}"
          VERSION="Box64-${LABEL}-${{ env.COMMIT_HASH }}"
          mkdir pkg_root
          
          # Setup profile.json
          if [[ "${{ matrix.type }}" == "wow64" ]]; then
            TYPE_JSON="WOWBox64"
            FILE_JSON='{"source": "system32/wowbox64.dll", "target": "${system32}/wowbox64.dll"}'
            cp -r system32 pkg_root/
          else
            TYPE_JSON="Box64"
            FILE_JSON='{"source": "box64", "target": "${bindir}/box64"}'
            cp box64 pkg_root/
          fi
          
          cat <<EOF > pkg_root/profile.json
          {
            "type": "$TYPE_JSON",
            "versionName": "$VERSION",
            "versionCode": 1,
            "description": "Box64 ${LABEL}\nCommit: ${{ env.COMMIT_HASH }}",
            "files": [ $FILE_JSON ]
          }
          EOF
          
          # Create ZIP
          cd pkg_root
          zip -r "../${VERSION}.zip" .
          
          # Create WCP (Zstandard compressed tar)
          tar --zstd -cf "../${VERSION}.wcp" .
          cd ..

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.repo }}-${{ matrix.type }}
          path: |
            *.wcp
            *.zip
