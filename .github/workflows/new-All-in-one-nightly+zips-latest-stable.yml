name: All-in-One Emulation Nightlies

on:
  schedule:
    - cron: '30 8 * * *' # Runs every day at 08:30 UTC
  workflow_dispatch:

jobs:
  # ==================================================================
  # JOB 1: Box64 Matrix (All 6 Variants)
  # ==================================================================
  build-box64-matrix:
    name: Build Box64 ${{ matrix.source }} (${{ matrix.type }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        type: [Native, Bionic, WOW64]
        source: [Official, Hybrid]
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make python3 p7zip-full wget tar file unzip xz-utils zip

      # --- CACHE BLOCKS ---
      - name: Cache Android NDK
        if: matrix.type != 'WOW64'
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/android-ndk-r26b
          key: android-ndk-r26b-linux

      - name: Cache LLVM-MinGW (WOW64)
        if: matrix.type == 'WOW64'
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/llvm-mingw-20240619-ucrt-ubuntu-20.04-x86_64
          key: llvm-mingw-20240619
      # --------------------

      - name: Setup Toolchain (Android)
        if: matrix.type != 'WOW64'
        run: |
          if [ ! -d "$PWD/android-ndk-r26b" ]; then
            echo "Cache miss: Downloading NDK..."
            wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
            unzip -q android-ndk-r26b-linux.zip
          else
            echo "Cache hit: NDK found!"
          fi

          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV
          if [ "${{ matrix.type }}" == "Bionic" ]; then
            echo "BOX64_COMPILER=$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android31-clang" >> $GITHUB_ENV
          else
            echo "BOX64_COMPILER=$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android28-clang" >> $GITHUB_ENV
          fi

      - name: Setup Toolchain (WOW64 MinGW)
        if: matrix.type == 'WOW64'
        run: |
          LLVM_MINGW_VERSION=20240619
          if [ ! -d "$PWD/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64" ]; then
            echo "Cache miss: Downloading LLVM-MinGW..."
            wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64.tar.xz
            tar -xf llvm-mingw-*.tar.xz
          else
            echo "Cache hit: LLVM-MinGW found!"
          fi

          echo "MINGW_PATH=$PWD/$(ls -d llvm-mingw-* | head -n 1)/bin" >> $GITHUB_ENV

      - name: Clone & Merge Source
        run: |
          git clone https://github.com/ptitSeb/box64 source
          cd source

          if [ "${{ matrix.source }}" == "Hybrid" ]; then
            git remote add pipetto https://github.com/Pipetto-crypto/box64
            git fetch pipetto
            git config user.email "action@github.com"
            git config user.name "GitHub Action"
            git merge pipetto/main --no-edit || { echo "MERGE FAILED"; exit 1; }
          fi

          if [ "${{ matrix.type }}" == "WOW64" ]; then
            mkdir -p wine/common
            echo -e '\nint __mingw_vsprintf(char* buffer, const char* format, va_list args) { return vsprintf(buffer, format, args); }' >> wine/common/crt.c
          fi

      - name: Get Version Info
        id: version
        run: |
          cd source
          COMMIT=$(git rev-parse --short HEAD)

          if [ "${{ matrix.source }}" == "Official" ]; then
            MAJOR=$(grep '#define BOX64_MAJOR' src/box64version.h | awk '{print $3}')
            MINOR=$(grep '#define BOX64_MINOR' src/box64version.h | awk '{print $3}')
            REVISION=$(grep '#define BOX64_REVISION' src/box64version.h | awk '{print $3}')
            echo "FULL_VERSION=Box64-${MAJOR}.${MINOR}.${REVISION}-${COMMIT}-${{ matrix.type }}" >> $GITHUB_ENV
          else
            echo "FULL_VERSION=Box64-Hybrid-${{ matrix.type }}-${COMMIT}" >> $GITHUB_ENV
          fi

      - name: Configure and Build
        run: |
          mkdir build && cd build

          if [ "${{ matrix.type }}" == "WOW64" ]; then
            export PATH=$PATH:${{ env.MINGW_PATH }}
            cmake ../source \
              -DCMAKE_C_COMPILER=aarch64-w64-mingw32-gcc \
              -DWOW64=1 -DARM_DYNAREC=1 -DCMAKE_BUILD_TYPE=Release
            make -j$(nproc) wowbox64
          else
            if [ "${{ matrix.type }}" == "Bionic" ]; then
              CMAKE_ARGS="-DBIONIC=1 -DTERMUX=0 -DHAVE_TRACE=0"
            else
              CMAKE_ARGS=""
            fi

            cmake ../source \
              -DCMAKE_C_COMPILER=${{ env.BOX64_COMPILER }} \
              -DANDROID=1 -DARM_DYNAREC=1 -DBAD_SIGNAL=1 -DCMAKE_BUILD_TYPE=Release $CMAKE_ARGS
            make -j$(nproc)

            if [ "${{ matrix.type }}" == "Bionic" ]; then
              readelf -d box64 | grep -q "NEEDED.*libc.so" || { echo "Linking failed!"; exit 1; }
            fi

            ${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip box64
          fi

      - name: Package
        run: |
          mkdir -p $GITHUB_WORKSPACE/dist

          if [ "${{ matrix.type }}" == "WOW64" ]; then
            cd build/wowbox64-prefix/src/wowbox64-build
            echo '{"type": "WOWBox64", "versionName": "${{ env.FULL_VERSION }}", "versionCode": 0, "description": "WOWBox64 ${{ matrix.source }}", "files": [{"source": "system32/wowbox64.dll", "target": "${system32}/wowbox64.dll"}]}' > profile.json

            mkdir -p system32 && cp wowbox64.dll system32/
            tar -cJf "${{ env.FULL_VERSION }}.wcp" system32 profile.json
            zip -r "${{ env.FULL_VERSION }}.zip" system32 profile.json

            mv *.wcp *.zip $GITHUB_WORKSPACE/dist/
          else
            cd build
            echo '{"type": "Box64", "versionName": "${{ env.FULL_VERSION }}", "versionCode": 0, "description": "Box64 ${{ matrix.source }} ${{ matrix.type }}", "files": [{"source": "box64", "target": "${bindir}/box64"}]}' > profile.json

            mkdir pkg_content
            cp box64 profile.json pkg_content/

            cd pkg_content
            zip -r "../${{ env.FULL_VERSION }}.zip" .
            tar -cf ../temp.tar .
            cd ..
            xz -9 -c temp.tar > "${{ env.FULL_VERSION }}.wcp"

            mv *.wcp *.zip $GITHUB_WORKSPACE/dist/
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: box64-${{ matrix.source }}-${{ matrix.type }}
          path: dist/*

  # ==================================================================
  # JOB 2: FEXCore Nightly
  # ==================================================================
  build-fex:
    name: Build FEXCore
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils jq git zip \
            build-essential python3 pkg-config cmake zstd \
            dos2unix perl tar unzip meson ninja-build wget

      - name: Setup GLSLANG
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang
          echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Setup Toolchain
        run: |
          LLVM_MINGW_TAG="20251104"
          TOOLCHAIN_DIR="/opt/llvm-mingw"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo rm -rf "$TOOLCHAIN_DIR" && sudo mkdir -p "$TOOLCHAIN_DIR"
          sudo tar -C "$TOOLCHAIN_DIR" --strip-components=1 -xJf llvm.tar.xz
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

      - name: Build FEX
        id: version
        run: |
          git clone --recursive https://github.com/FEX-Emu/FEX.git source
          cd source

          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "FEX-Unknown")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION_NAME="${LATEST_TAG}-Nightly-${COMMIT_HASH}"
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "version=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT_HASH}" >> $GITHUB_OUTPUT

          build_arch() {
            local triple="$1"
            local dest="$2"
            local build_dir="build-${triple}"

            rm -rf "$build_dir" && mkdir "$build_dir" && cd "$build_dir"
            cmake -G Ninja -Wno-dev \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
              -DMINGW_TRIPLE="${triple}-w64-mingw32" \
              -DCMAKE_INSTALL_PREFIX=/usr \
              -DCMAKE_INSTALL_LIBDIR=/usr/lib/wine/aarch64-windows \
              -DENABLE_JEMALLOC_GLIBC_ALLOC=False \
              -DENABLE_LTO=False -DENABLE_ASSERTIONS=False -DBUILD_TESTING=False \
              ..
            ninja -j 2
            DESTDIR="$dest" ninja install
            cd ..
          }

          build_arch "arm64ec" "../../stage-ec"
          build_arch "aarch64" "../../stage-wo"

      - name: Package
        run: |
          rm -rf final_package && mkdir -p final_package/system32
          DLL_EC=$(find stage-ec -type f -name '*.dll' | head -n 1)
          DLL_WOW=$(find stage-wo -type f -name '*.dll' | head -n 1)

          cp "$DLL_EC" final_package/system32/libarm64ecfex.dll
          cp "$DLL_WOW" final_package/system32/libwow64fex.dll
          /opt/llvm-mingw/bin/llvm-strip --strip-all final_package/system32/*.dll

          cat <<EOF > final_package/profile.json
          {
            "type": "FEXCore",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": ${{ github.run_number }},
            "description": "FEXCore Nightly\n${{ env.VERSION_NAME }}",
            "author": "FEX-Emu",
            "files": [
              { "source": "system32/libarm64ecfex.dll", "target": "\${system32}/libarm64ecfex.dll" },
              { "source": "system32/libwow64fex.dll", "target": "\${system32}/libwow64fex.dll" }
            ]
          }
          EOF

          cd final_package

          # Create WCP
          tar -cJf ../${{ env.VERSION_NAME }}.wcp .

          # Create ZIP
          zip -r ../${{ env.VERSION_NAME }}.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: fex-nightly
          path: |
            *.wcp
            *.zip

  # ==================================================================
  # JOB 3: VKD3D-Proton (Standard)
  # ==================================================================
  build-vkd3d:
    name: Build VKD3D-Proton (Standard)
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils jq git zip \
            build-essential python3 pkg-config zstd \
            meson ninja-build wget unzip

      - name: Setup GLSLANG
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang
          echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Setup Toolchain
        run: |
          LLVM_MINGW_TAG="20251104"
          TOOLCHAIN_DIR="/opt/llvm-mingw"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo rm -rf "$TOOLCHAIN_DIR" && sudo mkdir -p "$TOOLCHAIN_DIR"
          sudo tar -C "$TOOLCHAIN_DIR" --strip-components=1 -xJf llvm.tar.xz
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

      - name: Build VKD3D
        id: version
        run: |
          git clone --recursive https://github.com/HansKristian-Work/vkd3d-proton src
          cd src
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION_NAME="3.0b-${COMMIT_HASH}"
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "version=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          cd ..

          cat <<EOF > cross-x64.txt
          [binaries]
          c = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-clang'
          cpp = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-clang++'
          ar = '/opt/llvm-mingw/bin/llvm-ar'
          strip = '/opt/llvm-mingw/bin/llvm-strip'
          windres = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-windres'
          widl = '/opt/llvm-mingw/bin/x86_64-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          exe_wrapper = ['wine']
          [host_machine]
          system = 'windows'
          cpu_family = 'x86_64'
          cpu = 'x86_64'
          endian = 'little'
          EOF

          cat <<EOF > cross-x86.txt
          [binaries]
          c = '/opt/llvm-mingw/bin/i686-w64-mingw32-clang'
          cpp = '/opt/llvm-mingw/bin/i686-w64-mingw32-clang++'
          ar = '/opt/llvm-mingw/bin/llvm-ar'
          strip = '/opt/llvm-mingw/bin/llvm-strip'
          windres = '/opt/llvm-mingw/bin/i686-w64-mingw32-windres'
          widl = '/opt/llvm-mingw/bin/i686-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          exe_wrapper = ['wine']
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

          cd src
          meson setup build-x64 --cross-file ../cross-x64.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x64 -j 2
          meson setup build-x86 --cross-file ../cross-x86.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x86 -j 2

      - name: Package
        run: |
          rm -rf final_package && mkdir -p final_package/system32 final_package/syswow64

          find src/build-x64 -name "d3d12.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-x64 -name "d3d12core.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-x86 -name "d3d12.dll" -exec cp -L {} final_package/syswow64/ \;
          find src/build-x86 -name "d3d12core.dll" -exec cp -L {} final_package/syswow64/ \;

          cat <<EOF > final_package/profile.json
          {
            "type": "VKD3D",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 1,
            "description": "${{ steps.version.outputs.commit }}",
            "files": [
              {"source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll"},
              {"source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll"},
              {"source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll"},
              {"source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll"}
            ]
          }
          EOF

          cd final_package

          # Create WCP
          tar -cJf ../VKD3D-Proton-${{ env.VERSION_NAME }}.wcp *

          # Create ZIP
          zip -r ../VKD3D-Proton-${{ env.VERSION_NAME }}.zip *

      - uses: actions/upload-artifact@v4
        with:
          name: vkd3d-standard
          path: |
            *.wcp
            *.zip

  # ==================================================================
  # JOB 4: DXVK Nightly (Standard)
  # ==================================================================
  build-dxvk:
    name: Build DXVK (GPLAsync)
    runs-on: ubuntu-latest
    outputs:
      commit: ${{ steps.version.outputs.commit }}
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 wget git xz-utils python3 meson ninja-build build-essential unzip zip ccache

      - name: Get DXVK Upstream Commit
        id: dxvk-hash
        run: |
          HASH=$(git ls-remote https://github.com/doitsujin/dxvk.git HEAD | cut -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Get week number (for glslang cache key)
        id: date
        run: echo "week=$(date +%Y-%W)" >> $GITHUB_OUTPUT

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          # Key tied to exact upstream commit ‚Äî auto-busts when DXVK has new commits
          key: ccache-dxvk-standard-${{ steps.dxvk-hash.outputs.hash }}
          # Fallback: load nearest prior cache so unchanged files still get reused
          restore-keys: ccache-dxvk-standard-

      - name: Cache glslang
        id: cache-glslang
        uses: actions/cache@v4
        with:
          path: glslang
          key: glslang-master-tot-${{ runner.os }}-${{ steps.date.outputs.week }}
          restore-keys: glslang-master-tot-${{ runner.os }}-

      - name: Download glslang
        if: steps.cache-glslang.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang

      - name: Add glslang to PATH
        run: echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Setup ccache compiler wrappers
        run: |
          # Create ccache-backed symlinks that shadow the real MinGW compilers.
          # package-release.sh picks compilers from PATH, so this is the cleanest
          # way to inject ccache without touching DXVK's own build scripts.
          mkdir -p ~/ccache-bin
          for compiler in \
            x86_64-w64-mingw32-gcc \
            x86_64-w64-mingw32-g++ \
            i686-w64-mingw32-gcc \
            i686-w64-mingw32-g++; do
            ln -s "$(which ccache)" ~/ccache-bin/$compiler
          done
          echo "$HOME/ccache-bin" >> $GITHUB_PATH
          ccache --max-size=1G
          ccache --zero-stats

      - name: Build DXVK
        id: version
        run: |
          # Full clone ‚Äî git describe requires commit history to locate the nearest tag.
          # Submodules stay shallow since they don't need git describe.
          git clone --recurse-submodules --shallow-submodules \
            https://github.com/doitsujin/dxvk.git dxvk
          cd dxvk
          LATEST_TAG=$(git describe --tags --abbrev=0)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION_NAME="${LATEST_TAG}-gplasync-${COMMIT_HASH}"
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "commit=${COMMIT_HASH}" >> $GITHUB_OUTPUT

          wget https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-master.patch
          git apply dxvk-gplasync-master.patch

          # Use all available vCPUs (runners have 4; was hardcoded to 2)
          sed -i 's/\bninja\b/ninja -j$(nproc)/g' package-release.sh
          ./package-release.sh master ../dxvk-built --no-package

      - name: Print ccache stats
        run: ccache --show-stats

      - name: Package
        run: |
          mkdir -p packaging
          cp -r dxvk-built/dxvk-master/x64 packaging/system32
          cp -r dxvk-built/dxvk-master/x32 packaging/syswow64

          cat <<EOF > packaging/profile.json
          {
            "type": "DXVK",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 0,
            "description": "Banners Repo (Upstream: Philip Rebohle, Patch: Ph42oN)",
            "files": [
              { "source": "system32/d3d10core.dll", "target": "\${system32}/d3d10core.dll" },
              { "source": "system32/d3d11.dll", "target": "\${system32}/d3d11.dll" },
              { "source": "system32/d3d8.dll", "target": "\${system32}/d3d8.dll" },
              { "source": "system32/d3d9.dll", "target": "\${system32}/d3d9.dll" },
              { "source": "system32/dxgi.dll", "target": "\${system32}/dxgi.dll" },
              { "source": "syswow64/d3d10core.dll", "target": "\${syswow64}/d3d10core.dll" },
              { "source": "syswow64/d3d11.dll", "target": "\${syswow64}/d3d11.dll" },
              { "source": "syswow64/d3d8.dll", "target": "\${syswow64}/d3d8.dll" },
              { "source": "syswow64/d3d9.dll", "target": "\${syswow64}/d3d9.dll" },
              { "source": "syswow64/dxgi.dll", "target": "\${syswow64}/dxgi.dll" }
            ]
          }
          EOF

          # WCP
          tar -cJf dxvk-gplasync-${{ steps.version.outputs.commit }}.wcp -C packaging .

          # ZIP
          cd packaging
          zip -r ../dxvk-gplasync-${{ steps.version.outputs.commit }}.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: dxvk-nightly
          path: |
            *.wcp
            *.zip

  # ==================================================================
  # JOB 5: VKD3D-Proton (ARM64EC)
  # ==================================================================
  build-vkd3d-arm64ec:
    name: Build VKD3D-Proton (ARM64EC)
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils jq git zip \
            build-essential python3 pkg-config zstd \
            meson ninja-build wget unzip

      - name: Setup GLSLANG
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang
          echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Setup Toolchain
        run: |
          LLVM_MINGW_TAG="20251104"
          TOOLCHAIN_DIR="/opt/llvm-mingw"
          wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
          sudo rm -rf "$TOOLCHAIN_DIR" && sudo mkdir -p "$TOOLCHAIN_DIR"
          sudo tar -C "$TOOLCHAIN_DIR" --strip-components=1 -xJf llvm.tar.xz
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

      - name: Build ARM64EC
        id: version
        run: |
          git clone --recursive https://github.com/HansKristian-Work/vkd3d-proton src
          cd src
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION_NAME="arm64ec-3.0b-${COMMIT_HASH}"
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "version=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          cd ..

          cat <<EOF > arm64ec.txt
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'arm64ec-w64-mingw32-windres'
          widl = 'arm64ec-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

          cat <<EOF > x86.txt
          [binaries]
          c = 'i686-w64-mingw32-clang'
          cpp = 'i686-w64-mingw32-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

          cd src
          meson setup build-ec --cross-file ../arm64ec.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-ec -j 2
          meson setup build-x86 --cross-file ../x86.txt -Dbuildtype=release -Dstrip=true
          ninja -C build-x86 -j 2

      - name: Package
        run: |
          rm -rf final_package && mkdir -p final_package/system32 final_package/syswow64

          find src/build-ec -name "d3d12.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-ec -name "d3d12core.dll" -exec cp -L {} final_package/system32/ \;
          find src/build-x86 -name "d3d12.dll" -exec cp -L {} final_package/syswow64/ \;
          find src/build-x86 -name "d3d12core.dll" -exec cp -L {} final_package/syswow64/ \;

          llvm-strip --strip-all final_package/system32/*.dll
          llvm-strip --strip-all final_package/syswow64/*.dll

          cat <<EOF > final_package/profile.json
          {
            "type": "VKD3D",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 1,
            "description": "${{ steps.version.outputs.commit }}",
            "files": [
              {"source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll"},
              {"source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll"},
              {"source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll"},
              {"source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll"}
            ]
          }
          EOF

          cd final_package

          # WCP
          tar --zstd -cf ../VKD3D-Proton-${{ env.VERSION_NAME }}.wcp *

          # ZIP
          zip -r ../VKD3D-Proton-${{ env.VERSION_NAME }}.zip *

      - uses: actions/upload-artifact@v4
        with:
          name: vkd3d-arm64ec
          path: |
            *.wcp
            *.zip

  # ==================================================================
  # JOB 6: DXVK ARM64EC (GPLAsync)
  # ==================================================================
  build-dxvk-arm64ec:
    name: Build DXVK (ARM64EC)
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates curl xz-utils jq git build-essential \
            python3 pkg-config zstd meson ninja-build wget unzip zip ccache

      - name: Get DXVK Upstream Commit
        id: dxvk-hash
        run: |
          HASH=$(git ls-remote https://github.com/doitsujin/dxvk.git HEAD | cut -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Get week number (for glslang cache key)
        id: date
        run: echo "week=$(date +%Y-%W)" >> $GITHUB_OUTPUT

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          # Key tied to exact upstream commit ‚Äî auto-busts when DXVK has new commits
          key: ccache-dxvk-arm64ec-${{ steps.dxvk-hash.outputs.hash }}
          # Fallback: load nearest prior cache so unchanged files still get reused
          restore-keys: ccache-dxvk-arm64ec-

      - name: Cache glslang
        id: cache-glslang
        uses: actions/cache@v4
        with:
          path: glslang
          key: glslang-master-tot-${{ runner.os }}-${{ steps.date.outputs.week }}
          restore-keys: glslang-master-tot-${{ runner.os }}-

      - name: Cache LLVM-MinGW
        uses: actions/cache@v4
        with:
          path: /opt/llvm-mingw
          # Version-pinned ‚Äî only re-downloads if you bump the tag below
          key: llvm-mingw-20251104-ubuntu22

      - name: Download glslang
        if: steps.cache-glslang.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/KhronosGroup/glslang/releases/download/master-tot/glslang-master-linux-Release.zip
          unzip -q glslang-master-linux-Release.zip -d glslang

      - name: Add glslang to PATH
        run: echo "$PWD/glslang/bin" >> $GITHUB_PATH

      - name: Setup LLVM-MinGW
        run: |
          if [ ! -d "/opt/llvm-mingw/bin" ]; then
            echo "Cache miss ‚Äî downloading LLVM-MinGW..."
            LLVM_MINGW_TAG="20251104"
            wget -q "https://github.com/mstorsjo/llvm-mingw/releases/download/$LLVM_MINGW_TAG/llvm-mingw-$LLVM_MINGW_TAG-ucrt-ubuntu-22.04-x86_64.tar.xz" -O llvm.tar.xz
            sudo mkdir -p /opt/llvm-mingw
            sudo tar -C /opt/llvm-mingw --strip-components=1 -xJf llvm.tar.xz
          else
            echo "Cache hit ‚Äî LLVM-MinGW ready."
          fi
          echo "/opt/llvm-mingw/bin" >> $GITHUB_PATH

      - name: Configure ccache
        run: |
          ccache --max-size=1G
          ccache --zero-stats

      - name: Clone & Patch DXVK
        id: version
        run: |
          # Full clone ‚Äî git describe requires commit history to locate the nearest tag.
          # Submodules stay shallow since they don't need git describe.
          git clone --recurse-submodules --shallow-submodules \
            https://github.com/doitsujin/dxvk.git dxvk
          cd dxvk
          LATEST_TAG=$(git describe --tags --abbrev=0)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION_NAME="${LATEST_TAG}-gplasync-arm64ec-${COMMIT_HASH}"
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "version=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT_HASH" >> $GITHUB_OUTPUT
          wget https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/main/patches/dxvk-gplasync-master.patch
          git apply dxvk-gplasync-master.patch

      - name: Configure Cross-Files
        run: |
          # ccache injected via the binaries array ‚Äî cleanest approach for meson cross builds
          cat <<EOF > arm64ec.txt
          [binaries]
          c = ['ccache', 'arm64ec-w64-mingw32-clang']
          cpp = ['ccache', 'arm64ec-w64-mingw32-clang++']
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'arm64ec-w64-mingw32-windres'
          widl = 'arm64ec-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

          cat <<EOF > x86.txt
          [binaries]
          c = ['ccache', 'i686-w64-mingw32-clang']
          cpp = ['ccache', 'i686-w64-mingw32-clang++']
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-widl'
          pkg-config = 'pkg-config'
          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

      - name: Build
        run: |
          cd dxvk
          meson setup build-ec --cross-file ../arm64ec.txt -Dbuildtype=release -Dstrip=true
          meson setup build-x86 --cross-file ../x86.txt -Dbuildtype=release -Dstrip=true
          # Use all available vCPUs (runners have 4; was hardcoded to 2)
          ninja -C build-ec -j$(nproc)
          ninja -C build-x86 -j$(nproc)

      - name: Print ccache stats
        run: ccache --show-stats

      - name: Package
        run: |
          mkdir -p packaging/system32
          mkdir -p packaging/syswow64

          copy_dll() {
            SRC_DIR=$1
            DEST_DIR=$2
            cp "dxvk/$SRC_DIR/src/d3d11/d3d11.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d10/d3d10core.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d9/d3d9.dll" "$DEST_DIR/"
            cp "dxvk/$SRC_DIR/src/d3d8/d3d8.dll" "$DEST_DIR/" || true
            cp "dxvk/$SRC_DIR/src/dxgi/dxgi.dll" "$DEST_DIR/"
          }
          copy_dll "build-ec" "packaging/system32"
          copy_dll "build-x86" "packaging/syswow64"
          llvm-strip --strip-all packaging/system32/*.dll
          llvm-strip --strip-all packaging/syswow64/*.dll

          cat <<EOF > packaging/profile.json
          {
            "type": "DXVK",
            "versionName": "${{ env.VERSION_NAME }}",
            "versionCode": 0,
            "description": "Banners Repo (Upstream: Philip Rebohle, Patch: Ph42oN)",
            "files": [
              { "source": "system32/d3d10core.dll", "target": "\${system32}/d3d10core.dll" },
              { "source": "system32/d3d11.dll", "target": "\${system32}/d3d11.dll" },
              { "source": "system32/d3d8.dll", "target": "\${system32}/d3d8.dll" },
              { "source": "system32/d3d9.dll", "target": "\${system32}/d3d9.dll" },
              { "source": "system32/dxgi.dll", "target": "\${system32}/dxgi.dll" },
              { "source": "syswow64/d3d10core.dll", "target": "\${syswow64}/d3d10core.dll" },
              { "source": "syswow64/d3d11.dll", "target": "\${syswow64}/d3d11.dll" },
              { "source": "syswow64/d3d8.dll", "target": "\${syswow64}/d3d8.dll" },
              { "source": "syswow64/d3d9.dll", "target": "\${syswow64}/d3d9.dll" },
              { "source": "syswow64/dxgi.dll", "target": "\${syswow64}/dxgi.dll" }
            ]
          }
          EOF

          cd packaging

          # WCP
          tar --zstd -cf ../DXVK-ARM64EC-${{ env.VERSION_NAME }}.wcp .

          # ZIP
          zip -r ../DXVK-ARM64EC-${{ env.VERSION_NAME }}.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: dxvk-arm64ec
          path: |
            *.wcp
            *.zip

  # ==================================================================
  # JOB 7: Release
  # ==================================================================
  create-release:
    name: Create Nightly Release
    runs-on: ubuntu-latest
    needs: [build-box64-matrix, build-fex, build-vkd3d, build-dxvk, build-vkd3d-arm64ec, build-dxvk-arm64ec]
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Set Release Variables
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          READABLE_DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')
          echo "TAG_NAME=nightly-$TIMESTAMP" >> $GITHUB_ENV
          echo "RELEASE_NAME=Emulation Nightly Build - $READABLE_DATE" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # Delete nightly releases older than 24 hours.
      # Uses the GitHub API to list all releases, filters to those whose
      # tag starts with "nightly-", checks the published_at timestamp,
      # and deletes both the release and its git tag if older than 24h.
      # Runs before creating the new release so we never briefly have
      # zero releases visible.
      # ----------------------------------------------------------------
      - name: Delete old nightly releases
        run: |
          CUTOFF=$(date -u -d '24 hours ago' +%s)
          PAGE=1

          while true; do
            # Fetch one page of releases (100 per page max)
            RELEASES=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100&page=$PAGE")

            # Stop if the page is empty
            COUNT=$(echo "$RELEASES" | jq length)
            if [ "$COUNT" -eq 0 ]; then
              break
            fi

            # Iterate over each release on this page
            echo "$RELEASES" | jq -c '.[]' | while read -r RELEASE; do
              TAG=$(echo "$RELEASE" | jq -r '.tag_name')
              RELEASE_ID=$(echo "$RELEASE" | jq -r '.id')
              PUBLISHED=$(echo "$RELEASE" | jq -r '.published_at')

              # Only touch releases made by this workflow (tag starts with "nightly-")
              if [[ "$TAG" != nightly-* ]]; then
                continue
              fi

              # Convert published_at to epoch seconds and compare
              PUBLISHED_EPOCH=$(date -u -d "$PUBLISHED" +%s)
              if [ "$PUBLISHED_EPOCH" -lt "$CUTOFF" ]; then
                echo "Deleting release: $TAG (published $PUBLISHED)"

                # Delete the release
                curl -s -X DELETE \
                  -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID"

                # Delete the associated git tag
                curl -s -X DELETE \
                  -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$TAG"

                echo "Deleted: $TAG"
              else
                echo "Keeping: $TAG (published $PUBLISHED, within 24h)"
              fi
            done

            PAGE=$((PAGE + 1))
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.RELEASE_NAME }}
          prerelease: false
          make_latest: true
          body: |
            ### üöÄ Nightly Build: ${{ env.TAG_NAME }}

            | Component | Source / Commit |
            | :--- | :--- |
            | **Box64 (All Variants)** | [ptitSeb/main](https://github.com/ptitSeb/box64/commits/main) |
            | **Box64 Hybrid (All Variants)** | [Pipetto/main](https://github.com/Pipetto-crypto/box64/commits/main) |
            | **FEXCore** | [${{ needs.build-fex.outputs.version }}](https://github.com/FEX-Emu/FEX/commit/${{ needs.build-fex.outputs.commit }}) |
            | **VKD3D-Proton (Std)** | [${{ needs.build-vkd3d.outputs.version }}](https://github.com/HansKristian-Work/vkd3d-proton/commit/${{ needs.build-vkd3d.outputs.commit }}) |
            | **VKD3D-Proton (ARM64EC)** | [${{ needs.build-vkd3d-arm64ec.outputs.version }}](https://github.com/HansKristian-Work/vkd3d-proton/commit/${{ needs.build-vkd3d-arm64ec.outputs.commit }}) |
            | **DXVK (GPLAsync)** | [${{ needs.build-dxvk.outputs.commit }}](https://github.com/doitsujin/dxvk/commit/${{ needs.build-dxvk.outputs.commit }}) |
            | **DXVK (ARM64EC)** | [${{ needs.build-dxvk-arm64ec.outputs.version }}](https://github.com/doitsujin/dxvk/commit/${{ needs.build-dxvk-arm64ec.outputs.commit }}) |

            ### üì¶ Files Included
            1. **Box64 Native**: `box64-*.wcp` (and `.zip`)
            2. **Box64 Bionic**: `box64-bionic-*.wcp` (and `.zip`)
            3. **WOWBox64**: `WOWBox64-*.wcp` (and `.zip`)
            4. **Box64 Hybrid Native**: `Box64-Hybrid-Native-*.wcp` (and `.zip`)
            5. **Box64 Hybrid Bionic**: `Box64-Hybrid-Bionic-*.wcp` (and `.zip`)
            6. **WOWBox64 Hybrid**: `WOWBox64-Hybrid-*.wcp` (and `.zip`)
            7. **FEXCore**: `FEX-*.wcp` (and `.zip`)
            8. **VKD3D-Proton (Std)**: `VKD3D-Proton-3.0b*.wcp` (and `.zip`)
            9. **VKD3D-Proton (ARM64EC)**: `VKD3D-Proton-3.0b-ARM64EC*.wcp` (and `.zip`)
            10. **DXVK**: `dxvk-gplasync-*.wcp` (and `.zip`)
            11. **DXVK (ARM64EC)**: `DXVK-ARM64EC-*.wcp` (and `.zip`)

            **The .wcp files are packaged for use with Winlator**
            **The .zip files are packaged for manual injection with Gamehub**
          files: |
            ./artifacts/*.wcp
            ./artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------------------
      # Discord notification ‚Äî success
      # Requires DISCORD_WEBHOOK_URL to be set in repo secrets:
      #   Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret
      # ----------------------------------------------------------------
      - name: Notify Discord (success)
        if: success()
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üöÄ New Nightly Build Released",
                "description": "**${{ env.RELEASE_NAME }}**\n\n[üì¶ Download from GitHub Releases](https://github.com/${{ github.repository }}/releases/tag/${{ env.TAG_NAME }})",
                "color": 5763719,
                "fields": [
                  {
                    "name": "Box64",
                    "value": "Native ¬∑ Bionic ¬∑ WOW64 (Official + Hybrid)",
                    "inline": false
                  },
                  {
                    "name": "FEXCore",
                    "value": "${{ needs.build-fex.outputs.version }}",
                    "inline": true
                  },
                  {
                    "name": "VKD3D-Proton",
                    "value": "${{ needs.build-vkd3d.outputs.version }}",
                    "inline": true
                  },
                  {
                    "name": "DXVK (GPLAsync)",
                    "value": "${{ needs.build-dxvk.outputs.commit }}",
                    "inline": true
                  },
                  {
                    "name": "DXVK (ARM64EC)",
                    "value": "${{ needs.build-dxvk-arm64ec.outputs.version }}",
                    "inline": true
                  }
                ],
                "footer": { "text": "GitHub Actions ¬∑ ${{ github.repository }}" },
                "timestamp": "${{ github.event.repository.updated_at }}"
              }]
            }'

      - name: Notify Discord (failure)
        if: failure()
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚ùå Nightly Build Failed",
                "description": "One or more jobs failed during the nightly run.\n\n[üîç View Actions Log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                "color": 15548997,
                "footer": { "text": "GitHub Actions ¬∑ ${{ github.repository }}" },
                "timestamp": "${{ github.event.repository.updated_at }}"
              }]
            }'
