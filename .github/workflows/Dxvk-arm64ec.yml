name: DXVK GPLAsync ARM64EC (WCP)

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository URL'
        required: true
        default: 'https://gitlab.com/Ph42oN/dxvk-gplasync.git'
      ref:
        description: 'Branch or Tag (e.g., master, v2.7.1)'
        required: true
        default: 'master'
      package_name:
        description: 'Name of the output package (without extension)'
        required: true
        default: 'dxvk-gplasync-arm64ec'

jobs:
  build-arm64ec:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        run: |
          git clone --recursive ${{ inputs.repository }} dxvk
          cd dxvk
          git checkout ${{ inputs.ref }}

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build glslang-tools curl tar zstd

      - name: Setup LLVM-MinGW (ARM64EC Support)
        run: |
          # We need LLVM-MinGW because standard GCC MinGW doesn't support ARM64EC well yet.
          # Downloading a known stable release.
          curl -L -o llvm-mingw.tar.xz https://github.com/mstorsjo/llvm-mingw/releases/download/20240903/llvm-mingw-20240903-ucrt-ubuntu-20.04-x86_64.tar.xz
          tar -xf llvm-mingw.tar.xz
          mv llvm-mingw-20240903-ucrt-ubuntu-20.04-x86_64 llvm-mingw
          echo "$(pwd)/llvm-mingw/bin" >> $GITHUB_PATH

      - name: Generate Cross-File
        working-directory: dxvk
        run: |
          cat <<EOF > build-arm64ec.txt
          [binaries]
          c = 'aarch64-w64-mingw32-clang'
          cpp = 'aarch64-w64-mingw32-clang++'
          ar = 'aarch64-w64-mingw32-ar'
          strip = 'aarch64-w64-mingw32-strip'
          windres = 'aarch64-w64-mingw32-windres'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'arm64ec'
          endian = 'little'
          EOF

      - name: Configure Meson
        working-directory: dxvk
        run: |
          meson setup build-arm64ec \
            --cross-file build-arm64ec.txt \
            --buildtype release \
            --strip \
            -Ddxvk_native=false

      - name: Build DXVK
        working-directory: dxvk
        run: ninja -C build-arm64ec

      - name: Package WCP (Winlator Structure)
        working-directory: dxvk
        run: |
          # Winlator expects x64 binaries in an 'x64' folder
          mkdir -p package/x64

          # Copy the ARM64EC DLLs into the x64 folder
          # (Winlator uses these to emulate x64 on Snapdragon devices)
          find build-arm64ec -name "*.dll" -exec cp {} package/x64/ \;

          # Create the .wcp file (which is just a zstd tarball)
          # We force owner/group to 0 for Android compatibility
          cd package
          tar --zstd --owner=0 --group=0 -cf ../${{ inputs.package_name }}.wcp *

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package_name }}
          path: dxvk/${{ inputs.package_name }}.wcp
          
