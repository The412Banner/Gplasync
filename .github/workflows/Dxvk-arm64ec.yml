name: DXVK GPLAsync ARM64EC WCP Builder

on:
  workflow_dispatch:
    inputs:
      version:
        description: "DXVK Version (Tag/Branch)"
        default: "main"
      device_name:
        description: "Name for the WCP (e.g. Adreno, Turnip)"
        default: "Generic"

jobs:
  build-wcp:
    name: Build Winlator WCP
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build git wget tar

      # ---------------------------------------------------------
      # 1. SETUP TOOLCHAIN (LLVM-MinGW)
      # ---------------------------------------------------------
      - name: Setup LLVM-MinGW Toolchain
        run: |
          # Download llvm-mingw (capable of arm64ec)
          wget https://github.com/mstorsjo/llvm-mingw/releases/download/20241217/llvm-mingw-20241217-ucrt-ubuntu-20.04-x86_64.tar.xz
          tar -xf llvm-mingw-*.tar.xz
          echo "$(pwd)/llvm-mingw-20241217-ucrt-ubuntu-20.04-x86_64/bin" >> $GITHUB_PATH

      # ---------------------------------------------------------
      # 2. CLONE DXVK-GPLASYNC
      # ---------------------------------------------------------
      - name: Clone DXVK GPLAsync
        run: |
          git clone https://gitlab.com/Ph42oN/dxvk-gplasync.git dxvk_src
          cd dxvk_src
          if [ "${{ inputs.version }}" != "main" ]; then
             git checkout "${{ inputs.version }}" || echo "Version not found, defaulting to main."
          fi

      # ---------------------------------------------------------
      # 3. BUILD ARM64EC (FIXED)
      # ---------------------------------------------------------
      - name: Configure & Build
        run: |
          # Create Cross File for ARM64EC
          cat <<EOF > cross-arm64ec.txt
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'arm64ec-w64-mingw32-ar'
          strip = 'arm64ec-w64-mingw32-strip'
          windres = 'arm64ec-w64-mingw32-windres'
          exe_wrapper = 'wine'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'arm64ec'
          endian = 'little'
          EOF

          # Build (Fixed Order: build_dir source_dir flags)
          meson setup dxvk_src/build dxvk_src \
            --cross-file cross-arm64ec.txt \
            --buildtype release \
            --prefix "$(pwd)/staging" \
            --strip
            
          ninja -C dxvk_src/build
          meson install -C dxvk_src/build

      # ---------------------------------------------------------
      # 4. PACKAGE INTO .WCP
      # ---------------------------------------------------------
      - name: Create WCP Package
        run: |
          # 1. Create structure
          mkdir -p WCP_ROOT/system32
          
          # 2. Copy compiled DLLs to system32 (ARM64EC goes here)
          cp staging/bin/*.dll WCP_ROOT/system32/
          
          # 3. Create profile.json (Manifest)
          cat <<EOF > WCP_ROOT/profile.json
          {
            "name": "DXVK GPLAsync ${{ inputs.version }} (ARM64EC)",
            "version": "${{ inputs.version }}",
            "author": "GitHub Actions",
            "description": "Custom build for ${{ inputs.device_name }}. Includes GPLAsync patches."
          }
          EOF

          # 4. Compress to .tar.xz and rename to .wcp
          cd WCP_ROOT
          tar -cJf ../dxvk-gplasync-arm64ec.wcp *

      - name: Upload WCP
        uses: actions/upload-artifact@v4
        with:
          name: DXVK-GPLAsync-ARM64EC-WCP
          path: dxvk-gplasync-arm64ec.wcp
