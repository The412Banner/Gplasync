name: Build Box64 & WOWBox64 Nightly

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  build-android-native:
    name: Build Box64 (Android Native)
    runs-on: ubuntu-latest
    outputs:
      full_version: ${{ steps.version.outputs.version }}
      commit_hash: ${{ steps.version.outputs.commit }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make python3 p7zip-full wget tar file

      - name: Setup Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV
          echo "BOX64_COMPILER=$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android28-clang" >> $GITHUB_ENV

      - name: Clone Box64
        run: git clone https://github.com/ptitSeb/box64 source

      - name: Get Version Info
        id: version
        run: |
          cd source
          MAJOR=$(grep '#define BOX64_MAJOR' src/box64version.h | awk '{print $3}')
          MINOR=$(grep '#define BOX64_MINOR' src/box64version.h | awk '{print $3}')
          REVISION=$(grep '#define BOX64_REVISION' src/box64version.h | awk '{print $3}')
          VERSION="$MAJOR.$MINOR.$REVISION"
          COMMIT=$(git rev-parse --short HEAD)
          FULL_V="${VERSION}-${COMMIT}-nightly"
          echo "FULL_VERSION=$FULL_V" >> $GITHUB_ENV
          echo "version=$FULL_V" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Configure and Build
        run: |
          mkdir build
          cd build
          cmake ../source \
            -DCMAKE_C_COMPILER=${{ env.BOX64_COMPILER }} \
            -DANDROID=1 \
            -DARM_DYNAREC=1 \
            -DBAD_SIGNAL=1 \
            -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          ${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip box64

      - name: Package
        run: |
          cd build
          echo '{"type": "Box64", "versionName": "${{ env.FULL_VERSION }}", "versionCode": 0, "description": "Box64-${{ env.FULL_VERSION }}. Author: MaxsTechReview", "files": [{"source": "box64", "target": "${bindir}/box64"}]}' > profile.json
          tar -cJf "box64-${{ env.FULL_VERSION }}.wcp" box64 profile.json

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: box64-android-native
          path: build/box64-*.wcp

  build-wowbox64:
    name: Build WOWBox64 (MinGW)
    runs-on: ubuntu-latest
    needs: build-android-native
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make python3 wget tar

      - name: Setup Toolchain
        run: |
          LLVM_MINGW_VERSION=20240619
          wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64.tar.xz
          tar -xf llvm-mingw-*.tar.xz
          echo "MINGW_PATH=$PWD/$(ls -d llvm-mingw-* | head -n 1)/bin" >> $GITHUB_ENV

      - name: Clone and Patch
        run: |
          git clone https://github.com/ptitSeb/box64 source
          cd source
          echo -e '\nint __mingw_vsprintf(char* buffer, const char* format, va_list args) { return vsprintf(buffer, format, args); }' >> wine/common/crt.c

      - name: Get Version Info
        run: |
          cd source
          MAJOR=$(grep '#define BOX64_MAJOR' src/box64version.h | awk '{print $3}')
          MINOR=$(grep '#define BOX64_MINOR' src/box64version.h | awk '{print $3}')
          REVISION=$(grep '#define BOX64_REVISION' src/box64version.h | awk '{print $3}')
          VERSION="$MAJOR.$MINOR.$REVISION"
          COMMIT=$(git rev-parse --short HEAD)
          echo "FULL_VERSION=${VERSION}-${COMMIT}-nightly" >> $GITHUB_ENV

      - name: Configure and Build
        run: |
          export PATH=$PATH:${{ env.MINGW_PATH }}
          mkdir build
          cd build
          cmake ../source \
            -DCMAKE_C_COMPILER=aarch64-w64-mingw32-gcc \
            -DWOW64=1 \
            -DARM_DYNAREC=1 \
            -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc) wowbox64

      - name: Package
        run: |
          cd build/wowbox64-prefix/src/wowbox64-build
          echo '{"type": "WOWBox64", "versionName": "${{ env.FULL_VERSION }}", "versionCode": 0, "description": "WOWBox64-${{ env.FULL_VERSION }}. Author: MaxsTechReview", "files": [{"source": "system32/wowbox64.dll", "target": "${system32}/wowbox64.dll"}]}' > profile.json
          mkdir -p system32 && cp wowbox64.dll system32/
          tar -cJf "WOWBox64-${{ env.FULL_VERSION }}.wcp" system32 profile.json

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wowbox64-mingw
          path: build/wowbox64-prefix/src/wowbox64-build/WOWBox64-*.wcp

  create-release:
    name: Create Nightly Release
    runs-on: ubuntu-latest
    needs: [build-android-native, build-wowbox64]
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: "Nightly Build: ${{ needs.build-android-native.outputs.full_version }}"
          body: |
            ### ðŸ›  Build Details
            - **Version**: ${{ needs.build-android-native.outputs.full_version }}
            - **Base Commit**: ${{ needs.build-android-native.outputs.commit_hash }}
            
            ### ðŸ“¦ Files Included
            - `box64-*.wcp`: Box64 Android Native
            - `WOWBox64-*.wcp`: WOWBox64 (MinGW)
            
            _These files are packaged with `profile.json` for easy installation._
          prerelease: true
          files: |
            ./artifacts/*.wcp
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    name: Cleanup Artifacts
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Delete build artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            box64-android-native
            wowbox64-mingw
