name: Box64 Hybrid Trio (Official + Pipetto)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 9 * * *' # Runs daily at 9 AM UTC

jobs:
  # ==================================================================
  # JOB 1: Box64 Hybrid (Standard Android)
  # ==================================================================
  build-hybrid-native:
    name: Build Hybrid (Native)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make python3 p7zip-full wget tar file unzip xz-utils zip

      - name: Setup Android NDK (r26b)
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV
          echo "BOX64_COMPILER=$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android28-clang" >> $GITHUB_ENV

      # --- HYBRID MERGE ---
      - name: Clone & Merge Source
        run: |
          git clone https://github.com/ptitSeb/box64 source
          cd source
          git remote add pipetto https://github.com/Pipetto-crypto/box64
          git fetch pipetto
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          echo "Merging Pipetto..."
          git merge pipetto/main --no-edit || { echo "MERGE FAILED"; exit 1; }

      - name: Get Version
        id: version
        run: |
          cd source
          COMMIT=$(git rev-parse --short HEAD)
          echo "FULL_VERSION=Box64-Hybrid-Native-${COMMIT}" >> $GITHUB_ENV

      - name: Configure and Build
        run: |
          mkdir build && cd build
          cmake ../source \
            -DCMAKE_C_COMPILER=${{ env.BOX64_COMPILER }} \
            -DANDROID=1 -DARM_DYNAREC=1 -DBAD_SIGNAL=1 -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          ${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip box64

      - name: Package
        run: |
          cd build
          echo '{"type": "Box64", "versionName": "${{ env.FULL_VERSION }}", "versionCode": 0, "description": "Box64 Hybrid (Native)\nOfficial + Pipetto", "files": [{"source": "box64", "target": "${bindir}/box64"}]}' > profile.json
          
          mkdir pkg_content
          cp box64 pkg_content/
          cp profile.json pkg_content/
          
          cd pkg_content
          zip -r "../${{ env.FULL_VERSION }}.zip" .
          tar -cf ../temp.tar .
          cd ..
          mv temp.tar temp_archive
          xz -9 -c temp_archive > "${{ env.FULL_VERSION }}.wcp"

      - uses: actions/upload-artifact@v4
        with:
          name: hybrid-native
          path: |
            build/*.wcp
            build/*.zip

  # ==================================================================
  # JOB 2: Box64 Hybrid (Bionic Optimized)
  # ==================================================================
  build-hybrid-bionic:
    name: Build Hybrid (Bionic)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make python3 p7zip-full wget tar file unzip xz-utils zip

      - name: Setup Android NDK (r26b)
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV
          # API 31 for Bionic
          echo "BOX64_COMPILER=$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android31-clang" >> $GITHUB_ENV

      # --- HYBRID MERGE ---
      - name: Clone & Merge Source
        run: |
          git clone https://github.com/ptitSeb/box64 source
          cd source
          git remote add pipetto https://github.com/Pipetto-crypto/box64
          git fetch pipetto
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git merge pipetto/main --no-edit || { echo "MERGE FAILED"; exit 1; }

      - name: Get Version
        id: version
        run: |
          cd source
          COMMIT=$(git rev-parse --short HEAD)
          echo "FULL_VERSION=Box64-Hybrid-Bionic-${COMMIT}" >> $GITHUB_ENV

      - name: Configure and Build (Bionic)
        run: |
          mkdir build && cd build
          cmake ../source \
            -DCMAKE_C_COMPILER=${{ env.BOX64_COMPILER }} \
            -DANDROID=1 -DBIONIC=1 -DARM_DYNAREC=1 -DBAD_SIGNAL=1 -DTERMUX=0 -DHAVE_TRACE=0 -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          readelf -d box64 | grep -q "NEEDED.*libc.so" || { echo "Linking failed!"; exit 1; }
          ${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip box64

      - name: Package
        run: |
          cd build
          echo '{"type": "Box64", "versionName": "${{ env.FULL_VERSION }}", "versionCode": 0, "description": "Box64 Hybrid (Bionic)\nOfficial + Pipetto", "files": [{"source": "box64", "target": "${bindir}/box64"}]}' > profile.json
          
          mkdir pkg_content
          cp box64 pkg_content/
          cp profile.json pkg_content/
          
          cd pkg_content
          zip -r "../${{ env.FULL_VERSION }}.zip" .
          tar -cf ../temp.tar .
          cd ..
          mv temp.tar temp_archive
          xz -9 -c temp_archive > "${{ env.FULL_VERSION }}.wcp"

      - uses: actions/upload-artifact@v4
        with:
          name: hybrid-bionic
          path: |
            build/*.wcp
            build/*.zip

  # ==================================================================
  # JOB 3: WOWBox64 Hybrid (MinGW)
  # ==================================================================
  build-hybrid-wow64:
    name: Build Hybrid (WOWBox64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake make python3 wget tar xz-utils zip

      - name: Setup Toolchain (LLVM-MinGW)
        run: |
          LLVM_MINGW_VERSION=20240619
          wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64.tar.xz
          tar -xf llvm-mingw-*.tar.xz
          echo "MINGW_PATH=$PWD/$(ls -d llvm-mingw-* | head -n 1)/bin" >> $GITHUB_ENV

      # --- HYBRID MERGE ---
      - name: Clone & Merge Source
        run: |
          git clone https://github.com/ptitSeb/box64 source
          cd source
          git remote add pipetto https://github.com/Pipetto-crypto/box64
          git fetch pipetto
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git merge pipetto/main --no-edit || { echo "MERGE FAILED"; exit 1; }
          
          # FIXED: Create directory first to prevent "No such file or directory" error
          mkdir -p wine/common
          echo -e '\nint __mingw_vsprintf(char* buffer, const char* format, va_list args) { return vsprintf(buffer, format, args); }' >> wine/common/crt.c

      - name: Get Version
        id: version
        run: |
          cd source
          COMMIT=$(git rev-parse --short HEAD)
          echo "FULL_VERSION=WOWBox64-Hybrid-${COMMIT}" >> $GITHUB_ENV

      - name: Configure and Build
        run: |
          export PATH=$PATH:${{ env.MINGW_PATH }}
          mkdir build && cd build
          cmake ../source \
            -DCMAKE_C_COMPILER=aarch64-w64-mingw32-gcc \
            -DWOW64=1 -DARM_DYNAREC=1 -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc) wowbox64

      - name: Package
        run: |
          cd build/wowbox64-prefix/src/wowbox64-build
          echo '{"type": "WOWBox64", "versionName": "${{ env.FULL_VERSION }}", "versionCode": 0, "description": "WOWBox64 Hybrid\nOfficial + Pipetto", "files": [{"source": "system32/wowbox64.dll", "target": "${system32}/wowbox64.dll"}]}' > profile.json
          mkdir -p system32 && cp wowbox64.dll system32/
          
          # ZIP (Raw)
          zip -r "${{ env.FULL_VERSION }}.zip" system32 profile.json
          
          # WCP (Winlator)
          tar -cJf "${{ env.FULL_VERSION }}.wcp" system32 profile.json

      - uses: actions/upload-artifact@v4
        with:
          name: hybrid-wow64
          path: |
            build/wowbox64-prefix/src/wowbox64-build/*.wcp
            build/wowbox64-prefix/src/wowbox64-build/*.zip
