name: Box64 Hybrid Trio (Official + Pipetto)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  schedule:
    - [span_5](start_span)cron: '0 9 * * *' # Runs daily at 9 AM UTC[span_5](end_span)

jobs:
  # ==================================================================
  # JOB 1: Box64 Hybrid (Standard Android)
  # ==================================================================
  build-hybrid-native:
    name: Build Hybrid (Native)
    runs-on: ubuntu-latest
    outputs:
      version: ${{ env.FULL_VERSION }}
      commit: ${{ env.COMMIT_HASH }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          [span_6](start_span)sudo apt-get install -y git cmake make python3 p7zip-full wget tar file unzip xz-utils zip[span_6](end_span)

      - name: Setup Android NDK (r26b)
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV
          [span_7](start_span)echo "BOX64_COMPILER=$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android28-clang" >> $GITHUB_ENV[span_7](end_span)

      - name: Clone & Merge Source
        run: |
          [span_8](start_span)git clone https://github.com/ptitSeb/box64 source[span_8](end_span)
          cd source
          [span_9](start_span)git remote add pipetto https://github.com/Pipetto-crypto/box64[span_9](end_span)
          [span_10](start_span)git fetch pipetto[span_10](end_span)
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git merge pipetto/main --no-edit || { echo "MERGE FAILED"; exit 1; [span_11](start_span)}
          echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Get Version
        run: echo "FULL_VERSION=Box64-Hybrid-Native-${{ env.COMMIT_HASH }}" >> $GITHUB_ENV[span_11](end_span)

      - name: Configure and Build
        run: |
          [span_12](start_span)mkdir build && cd build[span_12](end_span)
          [span_13](start_span)cmake ../source -DCMAKE_C_COMPILER=${{ env.BOX64_COMPILER }} -DANDROID=1 -DARM_DYNAREC=1 -DBAD_SIGNAL=1 -DCMAKE_BUILD_TYPE=Release[span_13](end_span)
          [span_14](start_span)make -j$(nproc)[span_14](end_span)
          [span_15](start_span)${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip box64[span_15](end_span)

      - name: Package
        run: |
          [span_16](start_span)cd build[span_16](end_span)
          [span_17](start_span)echo '{"type": "Box64", "versionName": "${{ env.FULL_VERSION }}", "versionCode": 0, "description": "Box64 Hybrid (Native)\nOfficial + Pipetto", "files": [{"source": "box64", "target": "${bindir}/box64"}]}' > profile.json[span_17](end_span)
          [span_18](start_span)mkdir pkg_content && cp box64 pkg_content/ && cp profile.json pkg_content/[span_18](end_span)
          cd pkg_content
          [span_19](start_span)zip -r "../${{ env.FULL_VERSION }}.zip" .[span_19](end_span)
          [span_20](start_span)tar -cf ../temp.tar .[span_20](end_span)
          cd ..
          [span_21](start_span)mv temp.tar temp_archive[span_21](end_span)
          [span_22](start_span)xz -9 -c temp_archive > "${{ env.FULL_VERSION }}.wcp"[span_22](end_span)
          rm temp_archive # Clean up leaked temp files

      - uses: actions/upload-artifact@v4
        with:
          name: hybrid-native
          path: |
            build/*.wcp
            [span_23](start_span)build/*.zip[span_23](end_span)

  # ==================================================================
  # JOB 2: Box64 Hybrid (Bionic Optimized)
  # ==================================================================
  build-hybrid-bionic:
    name: Build Hybrid (Bionic)
    runs-on: ubuntu-latest
    outputs:
      version: ${{ env.FULL_VERSION }}
      commit: ${{ env.COMMIT_HASH }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        [span_24](start_span)run: sudo apt-get update && sudo apt-get install -y git cmake make python3 p7zip-full wget tar file unzip xz-utils zip[span_24](end_span)

      - name: Setup Android NDK (r26b)
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV
          [span_25](start_span)echo "BOX64_COMPILER=$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android31-clang" >> $GITHUB_ENV[span_25](end_span)

      - name: Clone & Merge Source
        run: |
          [span_26](start_span)git clone https://github.com/ptitSeb/box64 source[span_26](end_span)
          cd source
          [span_27](start_span)git remote add pipetto https://github.com/Pipetto-crypto/box64[span_27](end_span)
          [span_28](start_span)git fetch pipetto[span_28](end_span)
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git merge pipetto/main --no-edit || { echo "MERGE FAILED"; exit 1; [span_29](start_span)}
          echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Get Version
        run: echo "FULL_VERSION=Box64-Hybrid-Bionic-${{ env.COMMIT_HASH }}" >> $GITHUB_ENV[span_29](end_span)

      - name: Configure and Build (Bionic)
        run: |
          [span_30](start_span)mkdir build && cd build[span_30](end_span)
          [span_31](start_span)cmake ../source -DCMAKE_C_COMPILER=${{ env.BOX64_COMPILER }} -DANDROID=1 -DBIONIC=1 -DARM_DYNAREC=1 -DBAD_SIGNAL=1 -DTERMUX=0 -DHAVE_TRACE=0 -DCMAKE_BUILD_TYPE=Release[span_31](end_span)
          [span_32](start_span)make -j$(nproc)[span_32](end_span)
          [span_33](start_span)${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip box64[span_33](end_span)

      - name: Package
        run: |
          [span_34](start_span)cd build[span_34](end_span)
          [span_35](start_span)echo '{"type": "Box64", "versionName": "${{ env.FULL_VERSION }}", "versionCode": 0, "description": "Box64 Hybrid (Bionic)\nOfficial + Pipetto", "files": [{"source": "box64", "target": "${bindir}/box64"}]}' > profile.json[span_35](end_span)
          [span_36](start_span)mkdir pkg_content && cp box64 pkg_content/ && cp profile.json pkg_content/[span_36](end_span)
          cd pkg_content
          [span_37](start_span)zip -r "../${{ env.FULL_VERSION }}.zip" .[span_37](end_span)
          [span_38](start_span)tar -cf ../temp.tar .[span_38](end_span)
          cd ..
          [span_39](start_span)mv temp.tar temp_archive[span_39](end_span)
          [span_40](start_span)xz -9 -c temp_archive > "${{ env.FULL_VERSION }}.wcp"[span_40](end_span)
          rm temp_archive

      - uses: actions/upload-artifact@v4
        with:
          name: hybrid-bionic
          path: |
            build/*.wcp
            [span_41](start_span)build/*.zip[span_41](end_span)

  # ==================================================================
  # JOB 3: WOWBox64 Hybrid (MinGW)
  # ==================================================================
  build-hybrid-wow64:
    name: Build Hybrid (WOWBox64)
    runs-on: ubuntu-latest
    outputs:
      version: ${{ env.FULL_VERSION }}
      commit: ${{ env.COMMIT_HASH }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        [span_42](start_span)run: sudo apt-get update && sudo apt-get install -y git cmake make python3 wget tar xz-utils zip[span_42](end_span)

      - name: Setup Toolchain (LLVM-MinGW)
        run: |
          [span_43](start_span)LLVM_MINGW_VERSION=20240619[span_43](end_span)
          [span_44](start_span)wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64.tar.xz[span_44](end_span)
          [span_45](start_span)tar -xf llvm-mingw-*.tar.xz[span_45](end_span)
          [span_46](start_span)echo "MINGW_PATH=$PWD/$(ls -d llvm-mingw-* | head -n 1)/bin" >> $GITHUB_ENV[span_46](end_span)

      - name: Clone & Merge Source
        run: |
          [span_47](start_span)git clone https://github.com/ptitSeb/box64 source[span_47](end_span)
          cd source
          [span_48](start_span)git remote add pipetto https://github.com/Pipetto-crypto/box64[span_48](end_span)
          [span_49](start_span)git fetch pipetto[span_49](end_span)
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git merge pipetto/main --no-edit || { echo "MERGE FAILED"; exit 1; [span_50](start_span)}
          echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          mkdir -p wine/common[span_50](end_span)
          echo -e '\nint __mingw_vsprintf(char* buffer, const char* format, va_list args) { return vsprintf(buffer, format, args); [span_51](start_span)}' >> wine/common/crt.c[span_51](end_span)

      - name: Get Version
        [span_52](start_span)run: echo "FULL_VERSION=WOWBox64-Hybrid-${{ env.COMMIT_HASH }}" >> $GITHUB_ENV[span_52](end_span)

      - name: Configure and Build
        run: |
          [span_53](start_span)export PATH=$PATH:${{ env.MINGW_PATH }}[span_53](end_span)
          [span_54](start_span)mkdir build && cd build[span_54](end_span)
          [span_55](start_span)cmake ../source -DCMAKE_C_COMPILER=aarch64-w64-mingw32-gcc -DWOW64=1 -DARM_DYNAREC=1 -DCMAKE_BUILD_TYPE=Release[span_55](end_span)
          [span_56](start_span)make -j$(nproc) wowbox64[span_56](end_span)

      - name: Package
        run: |
          [span_57](start_span)cd build/wowbox64-prefix/src/wowbox64-build[span_57](end_span)
          [span_58](start_span)echo '{"type": "WOWBox64", "versionName": "${{ env.FULL_VERSION }}", "versionCode": 0, "description": "WOWBox64 Hybrid\nOfficial + Pipetto", "files": [{"source": "system32/wowbox64.dll", "target": "${system32}/wowbox64.dll"}]}' > profile.json[span_58](end_span)
          [span_59](start_span)mkdir -p system32 && cp wowbox64.dll system32/[span_59](end_span)
          [span_60](start_span)zip -r "${{ env.FULL_VERSION }}.zip" system32 profile.json[span_60](end_span)
          [span_61](start_span)tar -cJf "${{ env.FULL_VERSION }}.wcp" system32 profile.json[span_61](end_span)

      - uses: actions/upload-artifact@v4
        with:
          name: hybrid-wow64
          path: |
            build/wowbox64-prefix/src/wowbox64-build/*.wcp
            [span_62](start_span)build/wowbox64-prefix/src/wowbox64-build/*.zip[span_62](end_span)

  # ==================================================================
  # JOB 4: Release
  # ==================================================================
  create-release:
    name: Create Hybrid Release
    runs-on: ubuntu-latest
    needs: [build-hybrid-native, build-hybrid-bionic, build-hybrid-wow64]
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Generate Date Tag
        run: echo "TAG_NAME=hybrid-$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Box64 Hybrid Nightly: ${{ env.TAG_NAME }}"
          body: |
            ### ðŸš€ Hybrid Component Commits
            | Component | Version | Build Commit (Merged) |
            | :--- | :--- | :--- |
            | **Native** | `${{ needs.build-hybrid-native.outputs.version }}` | [${{ needs.build-hybrid-native.outputs.commit }}](https://github.com/ptitSeb/box64/commit/${{ needs.build-hybrid-native.outputs.commit }}) |
            | **Bionic** | `${{ needs.build-hybrid-bionic.outputs.version }}` | [${{ needs.build-hybrid-bionic.outputs.commit }}](https://github.com/ptitSeb/box64/commit/${{ needs.build-hybrid-bionic.outputs.commit }}) |
            | **WOW64** | `${{ needs.build-hybrid-wow64.outputs.version }}` | [${{ needs.build-hybrid-wow64.outputs.commit }}](https://github.com/ptitSeb/box64/commit/${{ needs.build-hybrid-wow64.outputs.commit }}) |
            
            _Note: These versions represent a hybrid merge of official ptitSeb/box64 and Pipetto optimizations._
          files: |
            ./artifacts/*.wcp
            ./artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
