name: Build FEX-Emu

on:
  workflow_dispatch:

jobs:
  build-fex:
    runs-on: ubuntu-latest
    env:
      NDK_VERSION: android-ndk-r26b
      SDK_VERSION: 31

    steps:
      - name: Checkout FEX-Emu
        uses: actions/checkout@v4
        with:
          repository: FEX-Emu/FEX  # FIXED: Points to FEX source instead of backup repo
          fetch-depth: 1
          submodules: true # Fix for missing internal headers

      - name: Install System Dependencies
        run: |
          sudo apt-get update -yq
          sudo apt-get install -yq --no-install-recommends \
            git curl unzip zip python3 python3-venv ninja-build \
            patchelf gh glslang-tools bison flex cmake nasm

      - name: Setup Android NDK
        run: |
          mkdir -p $GITHUB_WORKSPACE/ndk
          # FIXED: Confirmed URL for NDK r26b Linux x86_64
          curl -L https://dl.google.com/android/repository/android-ndk-r26b-linux.zip -o ndk.zip
          unzip -q ndk.zip -d $GITHUB_WORKSPACE/ndk
          echo "ANDROID_NDK_HOME=$GITHUB_WORKSPACE/ndk/android-ndk-r26b" >> $GITHUB_ENV

      - name: Configure and Build FEX
        run: |
          mkdir -p build
          cmake -S . -B build \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-$SDK_VERSION \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=False \
            -DENABLE_LTO=False \
            -G Ninja
          ninja -C build

      - name: Package Artifact
        run: |
          mkdir -p output
          # Standard FEX binary locations after build
          find build/Source/Tools/ -name "FEXLoader" -exec cp {} output/ \;
          find build/Source/Tools/ -name "FEXInterpreter" -exec cp {} output/ \;
          zip -j fex-emu-android.zip output/*

      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: fex-emu-binaries
          path: fex-emu-android.zip
