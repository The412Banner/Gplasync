name: Build FEX-Emu

on:
  workflow_dispatch:

jobs:
  build-fex:
    runs-on: ubuntu-latest
    env:
      NDK_VERSION: android-ndk-r29
      SDK_VERSION: 31

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true # Crucial for FEX-Emu internal headers

      - name: Install System Dependencies
        run: |
          sudo apt-get update -yq
          sudo apt-get install -yq --no-install-recommends \
            git curl unzip zip python3 python3-venv ninja-build \
            patchelf gh glslang-tools bison flex cmake nasm

      - name: Setup Android NDK
        run: |
          mkdir -p $GITHUB_WORKSPACE/ndk
          curl -L https://dl.google.com/android/repository/android-ndk-r26b-linux.zip -o ndk.zip
          unzip -q ndk.zip -d $GITHUB_WORKSPACE/ndk
          echo "ANDROID_NDK_HOME=$GITHUB_WORKSPACE/ndk/android-ndk-r26b" >> $GITHUB_ENV

      - name: Configure and Build FEX
        run: |
          # Creating the build directory
          mkdir -p build
          
          # Running CMake directly with Android Toolchain variables
          cmake -S . -B build \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-$SDK_VERSION \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=False \
            -DENABLE_LTO=False \
            -G Ninja

          # Compiling
          ninja -C build

      - name: Package Artifact
        run: |
          mkdir -p output
          # Adjusting paths based on typical FEX output structure
          cp build/Source/Tools/FEXLoader/FEXLoader output/
          zip -j fex-emu-android.zip output/*

      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: fex-emu-binaries
          path: fex-emu-android.zip
          
